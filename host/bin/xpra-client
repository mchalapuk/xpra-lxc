#!/bin/bash
# Attaches to xpra server run in container specified in the argument

CONTAINER="$1"

# configuration start
OPTS="--microphone --speaker --speaker-codec=mp3 --mmap"
TTY="100"
SHARED_DIR="/shared/$CONTAINER/xpra"
TCP_PORT="8080"
XPRA_ADDR="tcp:$CONTAINER:$TCP_PORT"
# configuration end

die() { echo "$@" >&2; exit 1; }
usage() { echo "usage: xpra-client <lxc-container-name>" >&2; die $@; }

test -z $CONTAINER && usage "container not specified"
test -n "`lxc-ls ^$CONTAINER\$`" || usage "no such container: $CONTAINER"
lxc-is-running $CONTAINER || die "container not running: $CONTAINER"
nc -w 1 -z $CONTAINER $TCP_PORT || die "xpra server not listening at $XPRA_ADDR"

TMPDIR=$SHARED_DIR xpra attach $XPRA_ADDR $OPTS
exit 0

